#!/bin/bash

VERSION_DSPACE="5.0"

sudo apt-get update
sudo apt-get install -y language-pack-en
sudo apt-get install -y software-properties-common python-software-properties

sudo add-apt-repository "deb http://ppa.launchpad.net/natecarlson/maven3/ubuntu precise main"
sudo apt-get update
sudo apt-get install -y maven3

#Remove software not needed to make the resultant instalattion a bit smaller
sudo apt-get remove -y brasero wodim tomboy f-spot gimp ekiga evolution transmission-common rhythmbox totem totem-plugins totem-common totem-mozilla maven2 transmission-gtk thunderbird xchat gimp parole xfburn 
sudo apt-get install -y openjdk-7-jdk 
sudo apt-get install -y ant ant-optional tomcat7 postgresql tomcat7-admin

#copiar o arquivo do tomcat
sudo cp tomcat7 /etc/default/tomcat7

#copiar o arquivo do postgresql
sudo cp pg_hba.conf /etc/postgresql/*/main/pg_hba.conf

# Clean up any old installation
echo Removing /dspace
sudo rm -rf /dspace

# Make the relevant directories
echo  - Making /dspace
sudo mkdir /dspace
sudo chown vagrant /dspace
su - vagrant

# Stop tomcat
echo Stopping tomcat
sudo service tomcat7 stop

# Restart postgresql
echo Restarting service postgresql
sudo service postgresql restart

# Create the postgres user and database
echo Initalise the database
echo  - Dropping old dspace database
sudo -u postgres dropdb dspace
echo  - Dropping old dspace Postgres users
sudo -u postgres dropuser dspace
echo  - Creating the dspace Postgres user
sudo -u postgres psql "-c CREATE USER dspace WITH PASSWORD 'dspace' CREATEDB;"
echo  - Creating the dspace database
createdb -U dspace dspace

# Download DSpace
echo Download DSpace source
echo  - Removing old copy of dspace-src
sudo rm -rf /dspace-src

echo  - Downloading new copy of DSpace
wget "http://sourceforge.net/projects/dspace/files/DSpace%20Stable/$VERSION_DSPACE/dspace-$VERSION_DSPACE-src-release.tar.gz"
echo  - Extracting the DSpace to /dspace-src
tar -vzxf "dspace-$VERSION_DSPACE-src-release.tar.gz"
# Remove unnecessary file
echo  - Removing file downloaded
sudo rm "dspace-$VERSION_DSPACE-src-release.tar.gz"

# Make the relevant directories
echo  - Making /dspace-src
sudo mkdir /dspace-src
sudo chown vagrant /dspace-src

echo  - "Copying dspace-$VERSION_DSPACE-src-release to /dspace-src"
cp -R "dspace-$VERSION_DSPACE-src-release/"* /dspace-src
# Remove unnecessary folder
sudo rm -rf "dspace-$VERSION_DSPACE-src-release"

# Build DSpace-installed
echo Building DSpace
# Change build.properties
echo  - Copying build.properties to /dspace-src/build.properties
sudo cp build.properties dspace-src/build.properties

echo  - Running 'mvn package' on /dspace-src
cd /dspace-src/dspace/
mvn3 -X package

echo  - Coping the customized dspace.cfg to /{dspace-build}/config
pwd=`pwd`
sudo cp $pwd/dspace.cfg "/dspace-src/dspace/target/dspace-installer/config/dspace.cfg"

echo  - Running ant fresh_install
cd "/dspace-src/dspace/target/dspace-installer/"
ant fresh_install

# Create an admin user
echo Creating a DSpace admin user: username = dspace password = dspace
/dspace/bin/dspace create-administrator -e dspace -f DSpace -l User -c en -p dspace

# Delete old tomcat webapps
echo Deleting old tomcat webapps
sudo rm -rf /var/lib/tomcat7/webapps/*

# Copy webapps to tomcat
echo Link webapps to tomcat
echo  - jspui to jspui-installed
sudo ln -s /dspace/webapps/jspui /var/lib/tomcat7/webapps/jspui
echo  - xmlui to xmlui-installed
sudo ln -s /dspace/webapps/xmlui /var/lib/tomcat7/webapps/xmlui
echo  - oai to oai-installed
sudo ln -s /dspace/webapps/oai /var/lib/tomcat7/webapps/oai
echo  - solr to solr
sudo ln -s /dspace/webapps/solr /var/lib/tomcat7/webapps/solr
echo  - sword to sword
sudo ln -s /dspace/webapps/sword /var/lib/tomcat7/webapps/sword
echo  - lni to lni
sudo ln -s /dspace/webapps/lni /var/lib/tomcat7/webapps/lni

echo Copying LiveCD ROOT webapp to tomcat
sudo cp -R $pwd/ROOT /var/lib/tomcat7/webapps/ROOT

# Start tomcat
echo Starting tomcat
sudo service tomcat7 start

# All done
echo
echo Build completed!
